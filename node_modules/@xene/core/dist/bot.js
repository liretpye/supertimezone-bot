"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const binder_1 = require("./binder");
const dialog_1 = require("./dialog");
const channel_1 = require("./channel");
class Bot {
    constructor() {
        /** @internal */
        this._dialogHandlers = [];
        /** @internal */
        this._performerHandlers = [];
        this.when = binder_1.Binder.for(this);
        this._channels = new Map();
    }
    /** @internal */
    _channelFor(channelId) {
        const channel = this._channels.get(channelId) || new channel_1.Channel();
        this._channels.set(channelId, channel);
        return channel;
    }
    dialog(channel, users) {
        return new dialog_1.Dialog(this, channel, users);
    }
    abortDialog(channel, user) {
        this._channelFor(channel).abort(user);
    }
    onMessage(message) {
        const performer = this._performerHandlers.find(c => c.match(message));
        if (performer)
            return performer.handler(message, this);
        const channel = this._channelFor(message.channel);
        const hasActions = channel.hasFor(message.user);
        if (hasActions)
            return channel.processMessage(message);
        const dialog = this._dialogHandlers.find(c => c.match(message));
        if (dialog) {
            const obj = this.dialog(message.channel, [message.user]);
            obj._manager.perform(message);
            dialog.handler(obj, this);
        }
    }
}
exports.Bot = Bot;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm90LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2JvdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFpQztBQUNqQyxxQ0FBaUM7QUFDakMsdUNBQW1DO0FBYW5DO0lBQUE7UUFDRSxnQkFBZ0I7UUFDaEIsb0JBQWUsR0FBMEIsRUFBRSxDQUFBO1FBQzNDLGdCQUFnQjtRQUNoQix1QkFBa0IsR0FBNkIsRUFBRSxDQUFBO1FBRWpELFNBQUksR0FBRyxlQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBR2YsY0FBUyxHQUFHLElBQUksR0FBRyxFQUFtQixDQUFBO0lBbUNoRCxDQUFDO0lBOUJDLGdCQUFnQjtJQUNoQixXQUFXLENBQUMsU0FBaUI7UUFDM0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxpQkFBTyxFQUFFLENBQUE7UUFDOUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQ3RDLE1BQU0sQ0FBQyxPQUFPLENBQUE7SUFDaEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxPQUFlLEVBQUUsS0FBZTtRQUNyQyxNQUFNLENBQUMsSUFBSSxlQUFNLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQTtJQUN6QyxDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQWUsRUFBRSxJQUFZO1FBQ3ZDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3ZDLENBQUM7SUFFUyxTQUFTLENBQUMsT0FBb0I7UUFDdEMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO1FBQ3JFLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUV0RCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUNqRCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUMvQyxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUM7WUFBQyxNQUFNLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUV0RCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO1FBQy9ELEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtZQUN4RCxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUM3QixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUMzQixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBNUNELGtCQTRDQyJ9